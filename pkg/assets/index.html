<head>
  <script type="text/javascript">
  // this is where we load our config from
  configURL = "/api/v1/authconfig"

  // loads json data from url, the callback is called with
  // error and data, with data the parsed json.
  var getJSON = function(url, token, callback) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    if (token != null)
      xhr.setRequestHeader("Authorization", "Bearer " + token)
    xhr.responseType = 'json';
    xhr.onload = function() {
      var status = xhr.status;
      if (status === 200) {
        callback(null, xhr.response);
      } else {
        callback(status, xhr.response);
      }
    };
    xhr.send();
  };

  // this loads the js library at location 'url' dynamically and
  // calls 'cbSuccess' when the library was loaded successfully
  // and 'cbError' when there was an error loading the library.
  function loadAuthLibrary(url, cbSuccess, cbError) {
    console.log("loading client library from " + url)
    var script = document.createElement('script');
    script.setAttribute('src', url);
    script.setAttribute('type', 'text/javascript');
    var loaded = false;
    var loadFunction = function () {
      if (loaded) return;
      loaded = true;
      cbSuccess();
    };
    var errorFunction = function (error) {
      if (loaded) return;
      cbError(error)
    };
    script.onerror = errorFunction;
    script.onload = loadFunction;
    script.onreadystatechange = loadFunction;
    document.getElementsByTagName("head")[0].appendChild(script);
  };

  // main operation, load config, load client, run client
  getJSON(configURL, null, function(err, data) {
    if (err !== null) {
      console.log('error loading client config' + err);
      document.getElementById('errorStatus').textContent = error;
    } else {
      loadAuthLibrary(data['auth-client-library-url'], function() {
        console.log("client library load success!")
        var clientConfig = JSON.parse(data['auth-client-config']);
        console.log("using client configuration: " + JSON.stringify(clientConfig))
        keycloak = Keycloak(clientConfig);
        keycloak.init().success(function(authenticated) {
          if (authenticated == true) {
            keycloak.loadUserInfo().success(function(data){
              document.getElementById('loginStatus').textContent = "logged in as user " + data.preferred_username;
              document.getElementById('jwtToken').textContent = JSON.stringify(keycloak.idTokenParsed, null, 2);
            });
            // setup websockets connection when the token is available
            if (window["WebSocket"]) {
              conn = new WebSocket("ws://" + document.location.host + "/ws" + "?token=" + keycloak.idToken);
              conn.onclose = function (evt) {
                console.log("ws connection closed");
              };
              conn.onmessage = function (evt) {
                console.log("message: " + evt.data);
              };
            } else {
              console.log("browser does not support websockets");
            }
          } else {
            document.getElementById('loginStatus').textContent = "not logged in";
          }
        }).error(function() {
          console.log('failed to initialize');
        });
      }, function(error) {
        console.log('error loading client library' + error);
        document.getElementById('errorStatus').textContent = error;
      });
    }
  });

  function doRequest() {
    // do an authenticated request
    // note, this only works if testingmode is set to true!
    getJSON("/api/v1/auth_test", keycloak.idToken, function(err, data) {
      if (err != null) {
        document.getElementById('errorStatus').textContent = error;
      } else {
        document.getElementById('serviceResp').textContent = JSON.stringify(data, null, 2);
      }
    })
  }

  function submitWs() {
    if (!conn) {
      return false;
    }
    if (!document.getElementById("msg").value) {
      return false;
    }
    conn.send(document.getElementById("msg").value);
    document.getElementById("msg").value = "";
    return false;
  };

</script>
</head>
<body>
  <h1>CodeReady Toolchain SaaS</h1>
  <p>
    <form id="form">
      <input type="button" value="Send" onclick="submitWs()"/>
      <input type="text" id="msg" size="64"/>
    </form>
  </p>
  <p>Login status: <b id="loginStatus"></b></p>
  <p>Error status: <b id="errorStatus"></b>n/a</p>
  <p>Please login or register: <button onclick="keycloak.login()">Login</button> <button onclick="keycloak.register()">Register</button></p>
  <p><button onclick="keycloak.logout()">Logout</button></p>
  <p>JWT Token:<br><pre id="jwtToken">n/a</pre></p>
  <p><button onclick="doRequest()">Perform authenticated Request</button> using the token..</p>
  <p>Authenticated Service Response:<br><pre id="serviceResp">n/a</pre></p>
</body>